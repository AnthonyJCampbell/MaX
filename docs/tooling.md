# Tooling

## Introduction

We use various development tools. What they are and how to set them up is detailed here

## Formatting

We use [Prettier](https://prettier.io/) for autoformatting. We decided on Prettier because it seems to be the most popular in the industry and its only real contender (JS Standard) has significant bugs.

### Configuration

Prettier is configured via `.prettierrc.yaml`. Configuration options can be found in the [docs](https://prettier.io/docs/en/options.html).

It's also configured to ignore any autogenerated code (i.e. anything in `autogen/`) via `.prettierignore`

To format all files, run `npm run format`.

### Setup

#### VS Code

- Install the `Prettier` extension
- Add this to `settings.json` (ctrl+comma>the open settings (JSON) icon button at the top right hand) to enable automatically formatting JavaScript on save

```JSON
    "[javascript]": {
        "editor.formatOnSave": true,
        "editor.defaultFormatter": "esbenp.prettier-vscode"
    },
    "[typescriptreact]": {
        "editor.formatOnSave": true,
        "editor.defaultFormatter": "esbenp.prettier-vscode"
    },
    "[typescript]": {
        "editor.formatOnSave": true,
        "editor.defaultFormatter": "esbenp.prettier-vscode"
    },
```

## Linting

We use [ESLint](https://eslint.org/) for linting. We decided on ESLint because it was the only popular linter with `JSX` support.

If you are using VS Code it is also recommended to use the [DevSkim](https://github.com/microsoft/DevSkim) plugin, for spotting some security issues in-editor.

It's possible to write our own rules for ESLint, see out [ESLint Plugin README](../tools/eslint-plugins/eslint-plugins-readme.md) for more info.

### Configuration

ESLint is configured via `.eslintrc.yml` files. Config options can be found in the [docs](https://eslint.org/docs/user-guide/configuring).

These config files apply to the directory they're in and all its sub-directories. Multiple config files can be included in the codebase. When a (code) file is being linted all config files in its directory "chain" are used, with those closest to it being prioritised in case of clashes. This effectively allows inheriting/overloading of config.

We use this feature to specify that code in the `public/` directory uses `Node`, and that code in the `src/` directory uses `React`. This allows ESLint to spot when a developer tries to use something in `Node` code that is only available in `React` and vice-versa.

ESLint can be configured to ignore files by adding them to `.eslintignore`.

We also use ESLint's security package to verify security best practices (see below).

### Setup

**VS Code**
For ESLint, just install the `ESLint` extension and you're good to go. It picks up all config files automatically and starts highlighting errors.

For DevSkim, just install the [`Microsoft Devskim` extension](https://marketplace.visualstudio.com/items?itemName=MS-CST-E.MicrosoftDevSkim) and you're good to go on that too.

## Security Scanning

We have several pipeline jobs checking the codebase for security issues.

- [Electronegativity](https://www.npmjs.com/package/@doyensec/electronegativity) is a tool specific to Electron. Run with `npx electronegativity -i {folders}`. Extra options include `-r` to print relative paths for files at fault, `-v` to give a verbose description of the issues and `-o` to output to a file (.csv or .sarif).

- We include [ESLint's security plugin](https://www.npmjs.com/package/eslint-plugin-security) as part of the ESLint job (see above).

- NPM has a built-in dependency auditing tool, `npm audit`. We wrap this into a dependency check CI job along with [retire](https://www.npmjs.com/package/retire).

- Finally, [NodeJsScan](https://github.com/ajinabraham/nodejsscan) provides a Node-specific security scan. We use its Python API, running inside a Python container.

## Copyright and Confidentiality statements

We have a linting rule ensuring every Javascript and Typescript file in the codebase starts with the one-line comment under `tools/copyright/codebase-header.js`.

This is also more robustly ensured (including also yaml, py and all other required files) via the `qs-checks` CI job.

If you want to use the QS tool to automatically fix all the missing statements, make sure to have at least version 6.5.0 of `qs` installed and run `qs check-copyright --fix --insert-date 2021`

## Debugging

### React and Redux Dev tools

These tools need to be installed into Chrome, and then the config adjusted so that the Electron process also picks them up.
Within the Electron process window, Ctrl-Shift-i is used to bring up the developer tools.

- Install the [React Developer Tools chrome extension](https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi?hl=en-GB) to use the **React** dev tools.

- Install the [Redux Developer Tools chrome extension](https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd?hl=en) to use the **Redux** dev tools.

- Create a file named `local-variables.js` inside `node-server/config` directory, containing the following variables `windowsUsername` and `usingMicrosoftEdge` swapped out as needed.

```js
// Copyright 2021 Metaswitch Networks - Highly Confidential Material
module.exports = {
  osUsername: "**INSERT_USER_NAME**",
  usingMicrosoftEdge: true, // Change this to false, if using Chrome instead
  usingWindows: true, // Change this to false, if using MacOS instead
  browserProfile: "Default" // Optional. Use this if you are using browser profiles, and change it to "Profile 1" or "Profile 2"
};
```

## CLI tools

We have a few scripts designed to be run as NPM scripts (i.e. `npm run <script-name> -- <args>`). They are found in `tools/cli/` and are mostly to improve user experience around installing packages.

In particular, `add-package` should be run whenever installing a new npm package:
`npm run add-package -- <package-name> [--save | --save-dev]`
